# –ë–æ—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è —É—á–µ–±–Ω–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è

–¢–µ–ª–µ–≥—Ä–∞–º-–±–æ—Ç –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–Ω—è—Ç–∏–π –¥–ª—è –≥—Ä—É–ø–ø, –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª–µ–π –∏ —É—á–µ–±–Ω—ã—Ö –∫–∞–±–∏–Ω–µ—Ç–æ–≤.

## –ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–ë–æ—Ç –∏–º–µ–µ—Ç –º–æ–¥—É–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –≥–¥–µ —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ –æ—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã:

- `–±—ã–ª–æ.py` - –æ—Å–Ω–æ–≤–Ω–æ–π —Ñ–∞–π–ª –±–æ—Ç–∞ —Å –∫–ª—é—á–µ–≤–æ–π –ª–æ–≥–∏–∫–æ–π
- `classroom_schedule.py` - –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º –∫–∞–±–∏–Ω–µ—Ç–æ–≤
- `cache_utils.py` - —É—Ç–∏–ª–∏—Ç—ã –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

## –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

### –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∫–∞–±–∏–Ω–µ—Ç–æ–≤

–ú–æ–¥—É–ª—å `classroom_schedule.py` –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
- –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞ –Ω–∞ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É
- –£—á—ë—Ç –∑–∞–º–µ–Ω –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π –∑–∞–Ω—è—Ç–∏–π –º–µ–∂–¥—É –∫–∞–±–∏–Ω–µ—Ç–∞–º–∏
- –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–±–∏–Ω–µ—Ç–æ–≤ (–≤–∫–ª—é—á–∞—è –∑–∞–º–µ–Ω—É –ª–∞—Ç–∏–Ω—Å–∫–∏—Ö –±—É–∫–≤ –Ω–∞ –∫–∏—Ä–∏–ª–ª–∏—á–µ—Å–∫–∏–µ)

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∫–∞–±–∏–Ω–µ—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É:
```
/classroom –£505 06.03.2025
```

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
```
üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –∫–∞–±–∏–Ω–µ—Ç–∞ –£505 –Ω–∞ —á–µ—Ç–≤–µ—Ä–≥ 06.03.2025 (—á–µ—Ç–Ω–∞—è –Ω–µ–¥–µ–ª—è):

2Ô∏è‚É£ ‚úèÔ∏è 1. (–õ–∞–±) –ú–µ—Ç—Ä–æ–ª–æ–≥–∏—è –∏ —ç–ª–µ–∫—Ç—Ä–æ—Ç–µ—Ö.–∏–∑–º–µ—Ä–µ–Ω–∏—è üéì–ò–≤–∞–Ω—á–µ–Ω–∫–æ –ê.–ü. üë• [–ö—Å-23-1, 1-—è –ø–æ–¥–≥—Ä—É–ø–ø–∞]

3Ô∏è‚É£ (–ö–ü) –ú–î–ö.03.01 –¢–µ—Ö. –æ–±—Å–ª. –∏ —Ä–µ–º. –∫–æ–º.—Å–∏—Å—Ç üéì–ò–≤–∞–Ω—á–µ–Ω–∫–æ –ê.–ü. üë• [–ö—Å–ö-21-1, 1-—è –ø–æ–¥–≥—Ä—É–ø–ø–∞]

4Ô∏è‚É£ (–ö–ü) –ú–î–ö.03.01 –¢–µ—Ö. –æ–±—Å–ª. –∏ —Ä–µ–º. –∫–æ–º.—Å–∏—Å—Ç üéì–ò–≤–∞–Ω—á–µ–Ω–∫–æ –ê.–ü. üë• [–ö—Å-21-1, 1-—è –ø–æ–¥–≥—Ä—É–ø–ø–∞]
```

–ì–¥–µ:
- 2Ô∏è‚É£, 3Ô∏è‚É£, 4Ô∏è‚É£ - –Ω–æ–º–µ—Ä –ø–∞—Ä—ã
- ‚úèÔ∏è - –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞–º–µ–Ω—ã
- üéì - –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å
- üë• - –≥—Ä—É–ø–ø–∞ –∏ –ø–æ–¥–≥—Ä—É–ø–ø–∞

# Enhanced Telegram Bot with True Concurrent Processing

This is an enhanced version of the Telegram bot that significantly improves performance when handling multiple users and processing Excel files.

## Key Improvements

1. **True Concurrent Command Handling**: 
   - Multiple users can interact with the bot simultaneously
   - Commands from different users are processed in parallel
   - Long-running operations don't block other users
   - Patched at the core dispatcher level for true concurrency

2. **Enhanced Teacher Schedule Processing**:
   - Parallel processing of Excel files with larger thread pools
   - Smart file selection based on date relevance
   - Request deduplication to avoid redundant work
   - Efficient caching of results
   - Preloading of Excel files for faster first-time access

3. **Advanced Excel File Caching**:
   - In-memory caching of Excel workbooks
   - Proactive preloading of Excel files at startup
   - Asynchronous file loading to avoid blocking
   - Automatic cache invalidation when files change
   - Significant performance improvement for Excel operations

4. **Non-Invasive Integration**:
   - Works without modifying the original code
   - Falls back to original implementation if enhanced version fails
   - Maintains backward compatibility

## How to Use

Instead of running the original bot directly, use the enhanced version by running:

```bash
python main.py
```

This will start the bot with all the performance enhancements while maintaining the same functionality.

## How It Works

The enhancement works through several mechanisms:

### True Concurrent Command Handling
- Patches the core dispatcher to process updates in separate tasks
- Wraps all command handlers to run as asyncio tasks
- Allows multiple commands to be processed simultaneously
- Tracks tasks by user ID for proper cleanup

### Teacher Schedule Processing
- Uses dedicated thread pools for Excel file processing
- Implements request deduplication to avoid redundant work
- Only processes Excel files relevant to the requested dates
- Caches results to avoid reprocessing
- Preloads Excel files to improve first-time performance

### Advanced Excel File Caching
- Maintains an in-memory cache of Excel workbooks
- Proactively preloads Excel files at startup
- Monitors files for changes to invalidate cache entries
- Limits cache size to prevent memory issues
- Significantly reduces file I/O operations

## Files

- `bot_concurrency.py`: Enables true concurrent command handling
- `teacher_schedule_processor.py`: Optimizes teacher schedule processing
- `excel_cache.py`: Implements advanced Excel file caching
- `schedule_wrapper.py`: Provides integration with the original code
- `main.py`: Entry point that applies all enhancements

## Performance Benefits

The enhanced version provides significant performance improvements:

1. **Multiple Users**: Bot can handle many users simultaneously with true concurrency
2. **Faster Response Times**: Excel processing is much faster, especially after first use
3. **Reduced Resource Usage**: Avoids redundant processing and file loading
4. **Better Scalability**: Can handle more users and larger workloads
5. **Improved First-Time Performance**: Proactive preloading reduces initial delays

## Troubleshooting

If you encounter any issues with the enhanced version, you can revert to the original implementation by running the original bot directly. 